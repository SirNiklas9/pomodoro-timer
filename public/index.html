<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/images/BananadoroLogo.png" type="image/png">
    <title>Bananadoro Timer</title>
</head>
<body>
    <img src="/images/BananadoroLogo.png" alt="BananadoroLogo" style="width: 150px; margin-bottom: 1rem;">

    <div id="auth-bar" style="margin-bottom: 1rem;">
        <span id="user-info"></span>
        <button id="authLink">Sign in</button>
        <button id="signOutLink" style="display: none;">Sign out</button>
    </div>

    <h1>Bananadoro Timer</h1>

    <div id="login">
        <hr>
        <div class="login-options">
            <button id="createBtn">Create Session</button>
            <div class="divider"></div>
            <div class="join-side">
                <input type="text" id="sessionCode" placeholder="Enter a session code...">
                <button id="joinBtn">Join</button>
            </div>
        </div>
    </div>

    <div id="app">
        <br>
        <div id="status-bar">
            <span id="sessionInfo"></span>
            <span id="userCount"></span>
        </div>
        <hr>
        <br>
        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
            <button id="timerMode">Work</button>
            <button id="settingsBtn" style="background: none; border: none; cursor: pointer; padding: 0.5rem;">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="#f4d03f">
                    <path d="M21.32 9.55l-1.89-.63a7.44 7.44 0 0 0-.65-1.57l.89-1.78a1 1 0 0 0-.17-1.15l-1.42-1.41a1 1 0 0 0-1.15-.17l-1.78.89a7.44 7.44 0 0 0-1.57-.65l-.63-1.89A1 1 0 0 0 13 .5h-2a1 1 0 0 0-.95.68l-.63 1.89a7.44 7.44 0 0 0-1.57.65l-1.78-.89a1 1 0 0 0-1.15.17L3.51 4.41a1 1 0 0 0-.17 1.15l.89 1.78a7.44 7.44 0 0 0-.65 1.57l-1.89.63A1 1 0 0 0 1 10.5v2a1 1 0 0 0 .68.95l1.89.63a7.44 7.44 0 0 0 .65 1.57l-.89 1.78a1 1 0 0 0 .17 1.15l1.41 1.41a1 1 0 0 0 1.15.17l1.78-.89a7.44 7.44 0 0 0 1.57.65l.63 1.89a1 1 0 0 0 .95.69h2a1 1 0 0 0 .95-.68l.63-1.89a7.44 7.44 0 0 0 1.57-.65l1.78.89a1 1 0 0 0 1.15-.17l1.41-1.41a1 1 0 0 0 .17-1.15l-.89-1.78a7.44 7.44 0 0 0 .65-1.57l1.89-.63a1 1 0 0 0 .69-.95v-2a1 1 0 0 0-.68-.95z"/>
                    <circle cx="12" cy="11.5" r="3" fill="#1a1a1a"/>
                </svg>
            </button>
        </div>
        <div id="timer">25:00</div>

        <div class="button-row">
            <button id="start">Start</button>
            <button id="stop">Stop</button>
            <button id="reset">Reset</button>
        </div>

        <div id="settings-overlay">
            <div id="settings-panel">
                <h3>Settings</h3>

                <label>Work Duration (minutes)</label>
                <input type="number" id="workDuration" value="25" min="0.1" max="120" step="0.1">

                <label>Break Duration (minutes)</label>
                <input type="number" id="breakDuration" value="5" min="0.1" max="60" step="0.1">

                <label style="flex-direction: row; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="soundEnabled" checked> Sound
                </label>
                <label style="flex-direction: row; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="notificationsEnabled" checked> Notifications
                </label>

                <button id="saveSettings">Save</button>
                <button id="closeSettings">Cancel</button>
            </div>
        </div>
    </div>

    <div id="auth-overlay">
        <div id="auth-panel">
            <h3 id="auth-title">Sign In</h3>

            <input type="text" id="authUsername" placeholder="Username">
            <input type="email" id="authEmail" placeholder="Email">
            <input type="password" id="authPassword" placeholder="Password">

            <button id="authSubmit">Sign In</button>
            <a href="#" id="authSwitch" style="color: #f4d03f; font-size: 0.8rem; text-align: center;">Need an account? Register</a>

            <div style="display: flex; align-items: center; gap: 1rem; opacity: 0.5;">
                <hr style="flex: 1; border-color: #444;">
                <span style="font-size: 0.8rem;">or</span>
                <hr style="flex: 1; border-color: #444;">
            </div>

            <div style="display: flex; justify-content: center; gap: 1rem;">
                <button id="authDiscord" class="oauth-btn" title="Continue with Discord">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                </button>
            </div>

            <button id="closeAuth" style="background: none; border: 1px solid #666; color: #666;">Cancel</button>
        </div>
    </div>

    <script>
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const status = document.getElementById('status');
        const sounds = {
            start: new Audio("/sounds/start.mp3"),
            stop: new Audio("/sounds/stop.mp3"),
            reset: new Audio("/sounds/reset.mp3"),
            simpleComplete: new Audio("/sounds/simple-ding.mp3"),
            complexComplete: new Audio("/sounds/complex-ding.mp3"),
            }

        let ws;
        let sessionCode;
        let userCount;
        let mode = 'work';

        let isRegisterMode = false;

        let isAppVisible = true;
        let lastTime = null;

        const savedWork = localStorage.getItem("workDuration");
        const savedBreak = localStorage.getItem("breakDuration");
        if (savedWork) document.getElementById("workDuration").value = savedWork;
        if (savedBreak) document.getElementById("breakDuration").value = savedBreak;

        if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.App) {
            Capacitor.Plugins.App.addListener('appStateChange', (state) => {
                isAppVisible = state.isActive;

                // Reconnect if coming back and disconnected
                if (state.isActive && sessionCode) {
                    // Check if we need to reconnect
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        // Don't call connectWebSocket directly - it might race
                        // Let the existing onclose handler deal with it, or:
                        if (!ws || ws.readyState === WebSocket.CLOSED) {
                            connectWebSocket();
                        }
                        // If CONNECTING, just wait - it's already trying
                    }
                }
            });
        } else {
            // Browser fallback
            document.addEventListener('visibilitychange', () => {
                isAppVisible = !document.hidden;
                if (!document.hidden && ws && ws.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                }
            });
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                if (sessionCode) {
                    ws.send(JSON.stringify({type: "join", sessionCode: sessionCode}));
                    updateStatusBar(sessionCode)
                } else {
                    ws.send(JSON.stringify({type: 'create'}))
                }
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type == "created") {
                    sessionCode = data.sessionCode;
                    localStorage.setItem("sessionCode", sessionCode);
                    updateStatusBar(sessionCode, 1)

                    // Send your saved durations to initialize the session
                    const workDuration = parseFloat(localStorage.getItem("workDuration")) || 25;
                    const breakDuration = parseFloat(localStorage.getItem("breakDuration")) || 5;

                    ws.send(JSON.stringify({
                        type: "settings",
                        workDuration: workDuration,
                        breakDuration: breakDuration
                    }));
                }

                if (data.type == "tick") {
                    // Check elements exist before updating
                    const timer = document.getElementById('timer');
                    const timerMode = document.getElementById('timerMode');
                    const sessionInfo = document.getElementById("sessionInfo");

                    // Only update if the app view is visible (elements exist)
                    if (!timer || !sessionInfo) return;

                        const minutes = Math.floor(data.time / 60);
                        const seconds = data.time % 60;
                        timer.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        document.title = `${minutes}:${seconds < 10 ? '0' : ''}${seconds} - Bananadoro`;
                        timerMode.textContent =
                            data.mode === "work" ? "Work" : "Break";
                        updateStatusBar(sessionCode, data.userCount)
                    }

                if (data.type == 'error') {
                    alert(data.message);

                    // Hide login, show app
                    document.getElementById("login").style.display = "block";
                    document.getElementById("app").style.display = "none";
                }

                if (data.time == 0 && lastTime !== null && lastTime > 0) {
                    const soundEnabled = localStorage.getItem("soundEnabled") !== "false";
                    const notificationsEnabled = localStorage.getItem("notificationsEnabled") !== "false";

                    let title = data.mode === "work" ? "Work Session Complete!" : "Break Session Complete!";
                    let body = data.mode === "work" ? "Time for a break!" : "Time to work!";

                    // Play sound only if visible
                    if (soundEnabled) {
                        sounds.complexComplete.play();
                    }

                    if (notificationsEnabled) {
                        // Tauri (Windows/Mac/Linux desktop)
                        if (window.__TAURI__?.notification) {
                            window.__TAURI__.notification.sendNotification({
                                title: title,
                                body: body,
                                icon: '/images/BananadoroLogo.png'
                            });
                        }

                        // Native notification (Capacitor)
                        if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.LocalNotifications) {
                            Capacitor.Plugins.LocalNotifications.schedule({
                                notifications: [{
                                    title: title,
                                    body: body,
                                    id: Math.floor(Math.random() * 100000)
                                }]
                            });
                        }
                        // Browser notification fallback
                        else if (typeof Notification !== 'undefined' && Notification.permission === "granted") {
                            new Notification(title, {
                                body: body,
                                icon: "/images/BananadoroLogo.png"
                            });
                        }
                    }
                } else {
                    document.addEventListener('visibilitychange', () => {
                        isAppVisible = !document.hidden;
                    });
                }

                lastTime = data.time;
            }

            ws.onclose = () => {
                document.getElementById("sessionInfo").textContent = "Disconnected - reconnecting...";
                setTimeout(() => {
                    console.log("Attempting reconnect, sessionCode:", sessionCode);
                    if (sessionCode) {
                        connectWebSocket();
                    }
                }, 2000);
            }
        }

        document.getElementById("createBtn").onclick = () => {
            if (!sessionCode) {

                if (typeof Notification !== 'undefined' && Notification.permission === "default") {
                    Notification.requestPermission();
                }

                // Request native notification permission
                if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.LocalNotifications) {
                    Capacitor.Plugins.LocalNotifications.requestPermissions();
                }

                // Hide login, show app
                document.getElementById("login").style.display = "none";
                document.getElementById("app").style.display = "block";

                connectWebSocket();
            }
        }

        document.getElementById("joinBtn").onclick = () => {
            sessionCode = document.getElementById("sessionCode").value.trim();
            if (!sessionCode) return;

            if (typeof Notification !== 'undefined' && Notification.permission === "default") {
                Notification.requestPermission();
            }

            // Request native notification permission
            if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.LocalNotifications) {
                Capacitor.Plugins.LocalNotifications.requestPermissions();
            }

            // Hide login, show app
            document.getElementById("login").style.display = "none";
            document.getElementById("app").style.display = "block";

            connectWebSocket();
        };

        function updateStatusBar(code, userCount) {
            document.getElementById("sessionInfo").innerHTML = `Connected to session <span id="copyArea" style="cursor: pointer;"><strong>${code}</strong> <span id="copyIcon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></span></span>`;

            document.getElementById("userCount").innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> ${userCount}`;

            document.getElementById("copyArea").addEventListener("click", () => {
                navigator.clipboard.writeText(code);
                document.getElementById("copyIcon").innerHTML = " âœ“";
                setTimeout(() => {
                    document.getElementById("copyIcon").innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
                }, 1000);
            });
        }



        // Events
        document.getElementById('authLink').onclick = (e) => {
            e.preventDefault();
            document.getElementById('auth-overlay').classList.add('active');
        };

        document.getElementById('closeAuth').onclick = () => {
            document.getElementById('auth-overlay').classList.remove('active');
        };

        document.getElementById('authSwitch').onclick = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('authLink').textContent = isRegisterMode ? 'Register' : 'Sign In';
            document.getElementById('authSubmit').textContent = isRegisterMode ? 'Register' : 'Sign In';
            document.getElementById('authSwitch').textContent = isRegisterMode ? 'Have an account? Sign In' : 'Need an account? Register';
            document.getElementById('authUsername').style.display = isRegisterMode ? 'block' : 'none';
        };

        document.getElementById('authSubmit').onclick = async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const username = document.getElementById('authUsername').value;

            const endpoint = isRegisterMode ? '/auth/register' : '/auth/login';
            const body = isRegisterMode
                ? { email, password, username }
                : { email, password };

            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            const data = await res.json();

            if (data.success) {
                document.getElementById('auth-overlay').classList.remove('active');
                checkAuth();
            } else {
                alert(data.error || 'Something went wrong');
            }
        };

        document.getElementById('authDiscord').onclick = () => {
            window.location.href = '/auth/discord';
        };


        document.getElementById('signOutLink').onclick = async (e) => {
            e.preventDefault();
            await fetch('/auth/logout', { method: 'POST' });
            checkAuth();
        };

        async function checkAuth() {
            const res = await fetch('/auth/me');
            const user = await res.json();

            if (user) {
                document.getElementById('user-info').innerHTML = `${user.username} <span style="opacity: 0.6;">(${user.provider})</span> `;
                document.getElementById('authLink').style.display = 'none';
                document.getElementById('signOutLink').style.display = 'inline';

                // Load settings from server
                const settingsRes = await fetch('/app/settings');
                const settings = await settingsRes.json();

                if (settings) {
                    document.getElementById('workDuration').value = settings.workDuration;
                    document.getElementById('breakDuration').value = settings.breakDuration;
                    document.getElementById('soundEnabled').checked = settings.soundEnabled;
                    document.getElementById('notificationsEnabled').checked = settings.notificationsEnabled;

                    localStorage.setItem('workDuration', settings.workDuration);
                    localStorage.setItem('breakDuration', settings.breakDuration);
                    localStorage.setItem('soundEnabled', settings.soundEnabled);
                    localStorage.setItem('notificationsEnabled', settings.notificationsEnabled);
                }
            } else {
                document.getElementById('user-info').textContent = '';
                document.getElementById('authLink').style.display = 'inline';
                document.getElementById('signOutLink').style.display = 'none';
            }
        }

        checkAuth();

        document.getElementById('start').onclick = () => {
            if (typeof Notification !== 'undefined') {
                Notification.requestPermission();
            }
            ws.send(JSON.stringify({type: 'start'}));
            sounds.start.play();
        };

        document.getElementById('stop').onclick = () => {
            ws.send(JSON.stringify({type: 'stop'}));
            sounds.stop.play();
        };

        document.getElementById('reset').onclick = () => {
            ws.send(JSON.stringify({type: 'reset'}));
            sounds.reset.play();
        };

        document.getElementById('timerMode').onclick = () => {
            mode = mode === "work" ? "break" : "work";
            ws.send(JSON.stringify({type: "toggleMode"}));
        };

        document.getElementById("settingsBtn").addEventListener("click", () => {
            document.getElementById("settings-overlay").classList.add("active");
        });

        document.getElementById("closeSettings").addEventListener("click", () => {
            document.getElementById("settings-overlay").classList.remove("active");
        });



        document.getElementById("saveSettings").addEventListener("click", () => {
            const workDuration = parseFloat(document.getElementById("workDuration").value);
            const breakDuration = parseFloat(document.getElementById("breakDuration").value);
            const soundEnabled = document.getElementById("soundEnabled").checked;
            const notificationsEnabled = document.getElementById("notificationsEnabled").checked;

            // Save to localStorage
            localStorage.setItem("workDuration", workDuration);
            localStorage.setItem("breakDuration", breakDuration);
            localStorage.setItem("soundEnabled", soundEnabled);
            localStorage.setItem("notificationsEnabled", notificationsEnabled);

            // Send to server
            ws.send(JSON.stringify({
                type: "settings",
                workDuration: workDuration,
                breakDuration: breakDuration
            }));

            fetch('/app/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ workDuration, breakDuration, soundEnabled, notificationsEnabled })
            });

            // Close overlay
            document.getElementById("settings-overlay").classList.remove("active");
        });
    </script>
</body>
</html>