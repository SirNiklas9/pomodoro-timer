<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/images/BananadoroLogo.png" type="image/png">
    <title>Bananadoro Timer</title>
</head>
<body>
    <img src="/images/BananadoroLogo.png" alt="BananadoroLogo" style="width: 150px; margin-bottom: 1rem;">
    <h1>Bananadoro Timer</h1>
    <div id="status">Waiting</div>

    <div id="login">
        <input type="text" id="username" placeholder="Enter username">
        <button id="joinBtn">Login</button>
    </div>

    <div id="app">
        <button id="timerMode">Switch Mode</button>
        <div id="timer">25:00</div>

        <div class="button-row">
            <button id="start">Start</button>
            <button id="stop">Stop</button>
            <button id="reset">Reset</button>
        </div>

    </div>

    <script>
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const status = document.getElementById('status');
        const sounds = {
            start: new Audio("/sounds/start.mp3"),
            stop: new Audio("/sounds/stop.mp3"),
            reset: new Audio("/sounds/reset.mp3"),
            simpleComplete: new Audio("/sounds/simple-ding.mp3"),
            complexComplete: new Audio("/sounds/complex-ding.mp3"),
            }

        let ws;
        let username;
        let mode = 'work';

        document.getElementById("joinBtn").onclick = () => {
            username = document.getElementById("username").value.trim();
            if (!username) return;

            if (typeof Notification !== 'undefined') {
                if (Notification.permission == "default") {
                    Notification.requestPermission();
                }
            }

            // Hide login, show app
            document.getElementById("login").style.display = "none";
            document.getElementById("app").style.display = "block";

            // Connect and join
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                ws.send(JSON.stringify({ type: "join", username: username }));
                document.getElementById("status").textContent = "Connected to room " + username;
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type == "tick") {
                    const minutes = Math.floor(data.time / 60);
                    const seconds = data.time % 60;
                    const timer = document.getElementById('timer');
                    timer.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    document.title = `${minutes}:${seconds < 10 ? '0' : ''}${seconds} - Bananadoro`;
                    document.getElementById('timerMode').textContent =
                        data.mode === "work" ? "Work" : "Break";
                }

                if (data.time == 0) {
                    sounds.complexComplete.play();
                    if (typeof Notification !== 'undefined') {
                        if (Notification.permission == "granted") {
                            new Notification("Bananadoro Complete!", {
                                body: "Time for a break!",
                                icon: "/images/BananadoroLogo.png"
                            });
                        }
                    }
                }
            };

            ws.onclose = () => {
                status.textContent = 'Disconnected';
            };
        };

        document.getElementById('start').onclick = () => {
            if (typeof Notification !== 'undefined') {
                Notification.requestPermission();
            }
            ws.send(JSON.stringify({type: 'start'}));
            sounds.start.play();
        };

        document.getElementById('stop').onclick = () => {
            ws.send(JSON.stringify({type: 'stop'}));
            sounds.stop.play();
        };

        document.getElementById('reset').onclick = () => {
            ws.send(JSON.stringify({type: 'reset'}));
            sounds.reset.play();
        };

        document.getElementById('timerMode').onclick = () => {
            if (mode == "work") {
                mode = "break";
                document.getElementById('timerMode').textContent = "Break"
                ws.send(JSON.stringify({type: "mode", mode: 'break'}))
            }
            else if (mode == "break") {
                mode = "work";
                document.getElementById('timerMode').textContent = "Work"
                ws.send(JSON.stringify({type: "mode", mode: 'work'}))
            }
        };
    </script>
</body>
</html>