<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/images/BananadoroLogo.png" type="image/png">
    <title>Bananadoro Timer</title>
</head>
<body>
    <img src="/images/BananadoroLogo.png" alt="BananadoroLogo" style="width: 150px; margin-bottom: 1rem;">
    <h1>Bananadoro Timer</h1>

    <div id="login">
        <hr>
        <div class="login-options">
            <button id="createBtn">Create Session</button>
            <div class="divider"></div>
            <div class="join-side">
                <input type="text" id="sessionCode" placeholder="Enter a session code...">
                <button id="joinBtn">Join</button>
            </div>
        </div>
    </div>

    <div id="app">
        <br>
        <div id="status-bar">
            <span id="sessionInfo"></span>
            <span id="userCount"></span>
        </div>
        <hr>
        <br>
        <button id="timerMode">Work</button>
        <div id="timer">25:00</div>

        <div class="button-row">
            <button id="start">Start</button>
            <button id="stop">Stop</button>
            <button id="reset">Reset</button>
        </div>

    </div>

    <script>
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const status = document.getElementById('status');
        const sounds = {
            start: new Audio("/sounds/start.mp3"),
            stop: new Audio("/sounds/stop.mp3"),
            reset: new Audio("/sounds/reset.mp3"),
            simpleComplete: new Audio("/sounds/simple-ding.mp3"),
            complexComplete: new Audio("/sounds/complex-ding.mp3"),
            }

        let ws;
        let sessionCode;
        let userCount;
        let mode = 'work';

        let isAppVisible = true;
        let lastTime = null;

        if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.App) {
            Capacitor.Plugins.App.addListener('appStateChange', (state) => {
                isAppVisible = state.isActive;

                // Reconnect if coming back and disconnected
                if (state.isActive && ws && ws.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                }
            });
        } else {
            // Browser fallback
            document.addEventListener('visibilitychange', () => {
                isAppVisible = !document.hidden;
                if (!document.hidden && ws && ws.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                }
            });
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                if (sessionCode) {
                    ws.send(JSON.stringify({type: "join", sessionCode: sessionCode}));
                    updateStatusBar(sessionCode)
                } else {
                    ws.send(JSON.stringify({type: 'create'}))
                }
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type == "created") {
                    sessionCode = data.sessionCode;
                    localStorage.setItem("sessionCode", sessionCode);
                    updateStatusBar(sessionCode, 1)
                }

                if (data.type == "tick") {
                    const minutes = Math.floor(data.time / 60);
                    const seconds = data.time % 60;
                    const timer = document.getElementById('timer');
                    timer.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    document.title = `${minutes}:${seconds < 10 ? '0' : ''}${seconds} - Bananadoro`;
                    document.getElementById('timerMode').textContent =
                        data.mode === "work" ? "Work" : "Break";
                    updateStatusBar(sessionCode, data.userCount)
                }

                if (data.type == 'error') {
                    alert(data.message);

                    // Hide login, show app
                    document.getElementById("login").style.display = "block";
                    document.getElementById("app").style.display = "none";
                }

                if (data.time == 0 && lastTime !== null && lastTime > 0) {
                    let title = mode === "work" ? "Work Session Complete!" : "Break Session Complete!";
                    let body = mode === "work" ? "Time for a break!" : "Time to work!";

                    // Play sound only if visible
                    if (isAppVisible) {
                        sounds.complexComplete.play();
                    }

                    // Tauri (Windows/Mac/Linux desktop)
                    if (window.__TAURI__?.notification) {
                        window.__TAURI__.notification.sendNotification({
                            title: title,
                            body: body,
                            icon: '/images/BananadoroLogo.png'
                        });
                    }

                    // Native notification (Capacitor)
                    if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.LocalNotifications) {
                        Capacitor.Plugins.LocalNotifications.schedule({
                            notifications: [{
                                title: title,
                                body: body,
                                id: Math.floor(Math.random() * 100000)
                            }]
                        });
                    }
                    // Browser notification fallback
                    else if (typeof Notification !== 'undefined' && Notification.permission === "granted") {
                        new Notification(title, {
                            body: body,
                            icon: "/images/BananadoroLogo.png"
                        });
                    }
                } else {
                    document.addEventListener('visibilitychange', () => {
                        isAppVisible = !document.hidden;
                    });
                }

            lastTime = data.time;
            }

            ws.onclose = () => {
                document.getElementById("status-bar").textContent = "Disconnected - reconnecting...";
                setTimeout(() => {
                    if (sessionCode) {
                        connectWebSocket();
                    }
                }, 2000);
            }
        }

        document.getElementById("createBtn").onclick = () => {
            if (!sessionCode) {

                if (typeof Notification !== 'undefined' && Notification.permission === "default") {
                    Notification.requestPermission();
                }

                // Request native notification permission
                if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.LocalNotifications) {
                    Capacitor.Plugins.LocalNotifications.requestPermissions();
                }

                // Hide login, show app
                document.getElementById("login").style.display = "none";
                document.getElementById("app").style.display = "block";

                connectWebSocket();
            }
        }

        document.getElementById("joinBtn").onclick = () => {
            sessionCode = document.getElementById("sessionCode").value.trim();
            if (!sessionCode) return;

            if (typeof Notification !== 'undefined' && Notification.permission === "default") {
                Notification.requestPermission();
            }

            // Request native notification permission
            if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.LocalNotifications) {
                Capacitor.Plugins.LocalNotifications.requestPermissions();
            }

            // Hide login, show app
            document.getElementById("login").style.display = "none";
            document.getElementById("app").style.display = "block";

            connectWebSocket();
        };

        function updateStatusBar(code, userCount) {
            document.getElementById("sessionInfo").innerHTML = `Connected to session <span id="copyArea" style="cursor: pointer;"><strong>${code}</strong> <span id="copyIcon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></span></span>`;

            document.getElementById("userCount").innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> ${userCount}`;

            document.getElementById("copyArea").addEventListener("click", () => {
                navigator.clipboard.writeText(code);
                document.getElementById("copyIcon").innerHTML = " âœ“";
                setTimeout(() => {
                    document.getElementById("copyIcon").innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
                }, 1000);
            });
        }



        // Events
        document.getElementById('start').onclick = () => {
            if (typeof Notification !== 'undefined') {
                Notification.requestPermission();
            }
            ws.send(JSON.stringify({type: 'start'}));
            sounds.start.play();
        };

        document.getElementById('stop').onclick = () => {
            ws.send(JSON.stringify({type: 'stop'}));
            sounds.stop.play();
        };

        document.getElementById('reset').onclick = () => {
            ws.send(JSON.stringify({type: 'reset'}));
            sounds.reset.play();
        };

        document.getElementById('timerMode').onclick = () => {
            mode = mode === "work" ? "break" : "work";
            ws.send(JSON.stringify({type: "toggleMode"}));
        };
    </script>
</body>
</html>