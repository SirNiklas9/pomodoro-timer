<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css?v=2.1.0">
    <link rel="icon" href="/images/BananadoroLogo.png" type="image/png">
    <title>Bananadoro Timer</title>
    <style>
        #oauthCodeVerifyBtn {
        }
    </style>
</head>
<body>
    <img src="/images/BananadoroLogo.png" alt="BananadoroLogo" style="width: 150px; margin-bottom: 1rem;">

    <div id="auth-bar" style="margin-bottom: 1rem;">
        <span id="user-info"></span>
        <button id="authLink">Sign in</button>
        <button id="signOutLink" style="display: none;">Sign out</button>
    </div>

    <h1>Bananadoro Timer</h1>

    <div id="login">
        <hr>
        <button id="resumeBtn" style="display: none; margin-bottom: 1rem;"></button>
        <div class="login-options">
            <button id="createBtn">Create Session</button>
            <div class="divider"></div>
            <div class="join-side">
                <input type="text" id="sessionCode" placeholder="Enter a session code...">
                <button id="joinBtn">Join</button>
            </div>
        </div>
        <button id="menuSettingsBtn" style="margin-top: 1rem; font-size: 0.8rem; padding: 0.5rem 1rem; opacity: 0.7;">Settings</button>
    </div>

    <div id="app">
        <br>
        <div id="status-bar">
            <button id="homeBtn" style="background: none; border: none; cursor: pointer; padding: 0.5rem;" title="Back to menu">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f4d03f" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </button>
            <span id="sessionInfo"></span>
            <span id="userCount"></span>
        </div>
        <hr>
        <br>
        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
            <button id="timerMode">Work</button>
            <button id="settingsBtn" style="background: none; border: none; cursor: pointer; padding: 0.5rem;">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="#f4d03f">
                    <path d="M21.32 9.55l-1.89-.63a7.44 7.44 0 0 0-.65-1.57l.89-1.78a1 1 0 0 0-.17-1.15l-1.42-1.41a1 1 0 0 0-1.15-.17l-1.78.89a7.44 7.44 0 0 0-1.57-.65l-.63-1.89A1 1 0 0 0 13 .5h-2a1 1 0 0 0-.95.68l-.63 1.89a7.44 7.44 0 0 0-1.57.65l-1.78-.89a1 1 0 0 0-1.15.17L3.51 4.41a1 1 0 0 0-.17 1.15l.89 1.78a7.44 7.44 0 0 0-.65 1.57l-1.89.63A1 1 0 0 0 1 10.5v2a1 1 0 0 0 .68.95l1.89.63a7.44 7.44 0 0 0 .65 1.57l-.89 1.78a1 1 0 0 0 .17 1.15l1.41 1.41a1 1 0 0 0 1.15.17l1.78-.89a7.44 7.44 0 0 0 1.57.65l.63 1.89a1 1 0 0 0 .95.69h2a1 1 0 0 0 .95-.68l.63-1.89a7.44 7.44 0 0 0 1.57-.65l1.78.89a1 1 0 0 0 1.15-.17l1.41-1.41a1 1 0 0 0 .17-1.15l-.89-1.78a7.44 7.44 0 0 0 .65-1.57l1.89-.63a1 1 0 0 0 .69-.95v-2a1 1 0 0 0-.68-.95z"/>
                    <circle cx="12" cy="11.5" r="3" fill="#1a1a1a"/>
                </svg>
            </button>
        </div>
        <div id="timer">25:00</div>

        <div class="button-row">
            <button id="start">Start</button>
            <button id="stop">Stop</button>
            <button id="reset">Reset</button>
        </div>
    </div>

    <div id="settings-overlay">
        <div id="settings-panel">
            <h3>Settings</h3>

            <label>Work Duration (minutes)</label>
            <input type="number" id="workDuration" value="25" min="0.1" max="120" step="0.1">

            <label>Break Duration (minutes)</label>
            <input type="number" id="breakDuration" value="5" min="0.1" max="60" step="0.1">

            <label style="flex-direction: row; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="soundEnabled" checked> Sound
            </label>
            <label style="flex-direction: row; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="notificationsEnabled" checked> Notifications
            </label>

            <button id="saveSettings">Save</button>
            <button id="closeSettings">Cancel</button>

            <button id="totpSettingsBtn" style="font-size: 0.85rem;">Enable 2FA</button>

            <details id="dangerZone" style="display: none;">

                <hr style="border-color: #444; margin: 1rem 0;">

                <summary style="color: #ff6b6b; cursor: pointer; text-align: center; font-size: 0.85rem; text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);">
                    ⚠️ Danger Zone
                </summary>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                    <button id="deleteDataBtn" style="background: transparent; border-color: #ff6b6b; color: #ff6b6b; font-size: 0.75rem;">
                        Delete Bananadoro Data
                    </button>
                    <button id="deleteAccountBtn" style="background: #ff6b6b; border-color: #ff6b6b; color: #1a1a1a; font-size: 0.75rem;">
                        Delete Account
                    </button>
                </div>
            </details>
        </div>
    </div>

    <div id="auth-overlay">
        <div id="auth-panel">
            <h3 id="auth-title">Sign In</h3>

            <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Sign in to sync your sessions across devices</p>

            <button id="authDiscord" class="oauth-btn" style="width: 100%; border-radius: 50px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                </svg>
                Continue with Discord
            </button>

            <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                <hr style="flex: 1; border-color: #444;">
                <span style="opacity: 0.6; font-size: 0.8rem;">or</span>
                <hr style="flex: 1; border-color: #444;">
            </div>

            <button id="authOtp" style="width: 100%;">Continue with Email</button>

            <button id="closeAuth" style="background: none; border: 1px solid #666; color: #666; margin-top: 0.5rem;">Cancel</button>
        </div>
    </div>

    <!-- Register Overlay -->
    <div id="register-overlay">
        <div id="register-panel">
            <h3>Create Account</h3>

            <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">We'll send you a verification code</p>

            <input type="text" id="registerUsername" placeholder="Username">
            <input type="email" id="registerEmail" placeholder="Email">

            <button id="registerBtn">Create Account</button>

            <a href="#" id="registerLoginLink" style="color: #f4d03f; font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">Already have an account? Sign In</a>

            <button id="closeRegister" style="background: none; border: 1px solid #666; color: #666; margin-top: 0.5rem;">Cancel</button>
        </div>
    </div>

    <!-- OTP Login Overlay -->
    <div id="otp-overlay">
        <div id="otp-panel">
            <h3 id="otp-title">Sign In with Email</h3>

            <div id="otp-email-step">
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">We'll send you a code</p>
                <input type="email" id="otpEmail" placeholder="Email">
                <button id="otpRequestBtn">Send Code</button>
            </div>

            <div id="otp-code-step" style="display: none;">
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Check your email for the code</p>
                <input type="email" id="otpEmailDisplay" disabled style="opacity: 0.6;">
                <input type="text" id="otpCode" placeholder="Enter code" maxlength="6" style="text-transform: uppercase; letter-spacing: 0.3em;">
                <button id="otpVerifyBtn">Verify</button>
                <a href="#" id="otpResend" style="color: #f4d03f; font-size: 0.8rem; text-align: center;">Resend code</a>
            </div>

            <button id="closeOtp" style="background: none; border: 1px solid #666; color: #666;">Cancel</button>
        </div>
    </div>

    <!-- TOTP Setup Overlay -->
    <div id="totp-setup-overlay">
        <div id="totp-setup-panel">
            <h3>Setup Two-Factor Auth</h3>

            <div id="totp-qr-step">
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Scan this QR code with your authenticator app</p>
                <div id="totp-qr" style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"></div>
                <p style="font-size: 0.75rem; opacity: 0.6;">Or enter manually:</p>
                <code id="totp-secret" style="font-size: 0.8rem; background: #333; padding: 0.5rem; border-radius: 4px; word-break: break-all;"></code>
            </div>

            <div id="totp-verify-step" style="margin-top: 1rem;">
                <input type="text" id="totpSetupCode" placeholder="Enter 6-digit code" maxlength="6">
                <button id="totpEnableBtn">Enable 2FA</button>
            </div>

            <button id="closeTotpSetup" style="background: none; border: 1px solid #666; color: #666;">Cancel</button>
        </div>
    </div>

    <!-- OAuth Code Entry Overlay (Mobile) -->
    <div id="oauth-code-overlay">
        <div id="oauth-code-panel">
            <h3>Enter Your Code</h3>
            <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Enter the code shown in your browser</p>

            <input type="text" id="oauthCode" placeholder="Enter code" maxlength="6" style="text-transform: uppercase; letter-spacing: 0.3em;">

            <button id="oauthCodeVerifyBtn">Verify</button>
            <button id="closeOauthCode" style="background: none; border: 1px solid #666; color: #666;">Cancel</button>
        </div>
    </div>

    <!-- TOTP Verify Overlay (during login) -->
    <div id="totp-verify-overlay">
        <div id="totp-verify-panel">
            <h3>Two-Factor Authentication</h3>
            <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Enter the code from your authenticator app</p>

            <input type="text" id="totpLoginCode" placeholder="Enter 6-digit code" maxlength="6">
            <input type="hidden" id="totpUserId">

            <button id="totpVerifyLoginBtn">Verify</button>
            <button id="closeTotpVerify" style="background: none; border: 1px solid #666; color: #666;">Cancel</button>
        </div>
    </div>

    <script>
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const status = document.getElementById('status');
        const sounds = {
            start: new Audio("/sounds/start.mp3"),
            stop: new Audio("/sounds/stop.mp3"),
            reset: new Audio("/sounds/reset.mp3"),
            simpleComplete: new Audio("/sounds/simple-ding.mp3"),
            complexComplete: new Audio("/sounds/complex-ding.mp3"),
            }

        let ws;
        let sessionCode;
        let userCount;
        let mode = 'work';

        let isRegisterMode = false;

        let isAppVisible = true;
        let lastTime = null;

        const savedWork = localStorage.getItem("workDuration");
        const savedBreak = localStorage.getItem("breakDuration");
        if (savedWork) document.getElementById("workDuration").value = savedWork;
        if (savedBreak) document.getElementById("breakDuration").value = savedBreak;

        if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.App) {
            Capacitor.Plugins.App.addListener('appStateChange', (state) => {
                isAppVisible = state.isActive;

                // Reconnect if coming back and disconnected
                if (state.isActive && sessionCode) {
                    // Check if we need to reconnect
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        // Don't call connectWebSocket directly - it might race
                        // Let the existing onclose handler deal with it, or:
                        if (!ws || ws.readyState === WebSocket.CLOSED) {
                            connectWebSocket();
                        }
                        // If CONNECTING, just wait - it's already trying
                    }
                }
            });
        } else {
            // Browser fallback
            document.addEventListener('visibilitychange', () => {
                isAppVisible = !document.hidden;
                if (!document.hidden && ws && ws.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                }
            });
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                if (sessionCode) {
                    ws.send(JSON.stringify({type: "join", sessionCode: sessionCode}));
                    updateStatusBar(sessionCode)
                } else {
                    ws.send(JSON.stringify({type: 'create'}))
                }
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type == "created") {
                    sessionCode = data.sessionCode;
                    localStorage.setItem("sessionCode", sessionCode);
                    updateStatusBar(sessionCode, 1)

                    // Save to account if logged in
                    fetch('/app/session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionCode: sessionCode })
                    });

                    // Send your saved durations to initialize the session
                    const workDuration = parseFloat(localStorage.getItem("workDuration")) || 25;
                    const breakDuration = parseFloat(localStorage.getItem("breakDuration")) || 5;

                    ws.send(JSON.stringify({
                        type: "settings",
                        workDuration: workDuration,
                        breakDuration: breakDuration
                    }));
                }

                if (data.type == "tick") {
                    // Check elements exist before updating
                    const timer = document.getElementById('timer');
                    const timerMode = document.getElementById('timerMode');
                    const sessionInfo = document.getElementById("sessionInfo");

                    // Only update if the app view is visible (elements exist)
                    if (!timer || !sessionInfo) return;

                        const minutes = Math.floor(data.time / 60);
                        const seconds = data.time % 60;
                        timer.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        document.title = `${minutes}:${seconds < 10 ? '0' : ''}${seconds} - Bananadoro`;
                        timerMode.textContent =
                            data.mode === "work" ? "Work" : "Break";
                        updateStatusBar(sessionCode, data.userCount)
                    }

                if (data.type == 'error') {
                    alert(data.message);

                    // Hide login, show app
                    document.getElementById("login").style.display = "block";
                    document.getElementById("app").style.display = "none";
                }

                if (data.time == 0 && lastTime !== null && lastTime > 0) {
                    const soundEnabled = localStorage.getItem("soundEnabled") !== "false";
                    const notificationsEnabled = localStorage.getItem("notificationsEnabled") !== "false";

                    let title = data.mode === "work" ? "Work Session Complete!" : "Break Session Complete!";
                    let body = data.mode === "work" ? "Time for a break!" : "Time to work!";

                    // Play sound only if visible
                    if (soundEnabled) {
                        sounds.complexComplete.play();
                    }

                    if (notificationsEnabled) {
                        // Tauri (Windows/Mac/Linux desktop)
                        if (window.__TAURI__?.notification) {
                            window.__TAURI__.notification.sendNotification({
                                title: title,
                                body: body,
                                icon: '/images/BananadoroLogo.png'
                            });
                        }

                        // Native notification (Capacitor)
                        if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.LocalNotifications) {
                            Capacitor.Plugins.LocalNotifications.schedule({
                                notifications: [{
                                    title: title,
                                    body: body,
                                    id: Math.floor(Math.random() * 100000)
                                }]
                            });
                        }
                        // Browser notification fallback
                        else if (typeof Notification !== 'undefined' && Notification.permission === "granted") {
                            new Notification(title, {
                                body: body,
                                icon: "/images/BananadoroLogo.png"
                            });
                        }
                    }
                } else {
                    document.addEventListener('visibilitychange', () => {
                        isAppVisible = !document.hidden;
                    });
                }

                lastTime = data.time;
            }

            ws.onclose = () => {
                document.getElementById("sessionInfo").textContent = "Disconnected - reconnecting...";
                setTimeout(() => {
                    console.log("Attempting reconnect, sessionCode:", sessionCode);
                    if (sessionCode) {
                        connectWebSocket();
                    }
                }, 2000);
            }
        }

        document.getElementById("createBtn").onclick = () => {
            if (!sessionCode) {

                if (typeof Notification !== 'undefined' && Notification.permission === "default") {
                    Notification.requestPermission();
                }

                // Request native notification permission
                if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.LocalNotifications) {
                    Capacitor.Plugins.LocalNotifications.requestPermissions();
                }

                // Hide login, show app
                document.getElementById("login").style.display = "none";
                document.getElementById("app").style.display = "block";

                connectWebSocket();
            }
        }

        document.getElementById("joinBtn").onclick = () => {
            sessionCode = document.getElementById("sessionCode").value.trim();
            if (!sessionCode) return;

            // Save to account if logged in
            fetch('/app/session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionCode: sessionCode })
            });

            if (typeof Notification !== 'undefined' && Notification.permission === "default") {
                Notification.requestPermission();
            }

            // Request native notification permission
            if (typeof Capacitor !== 'undefined' && Capacitor.Plugins?.LocalNotifications) {
                Capacitor.Plugins.LocalNotifications.requestPermissions();
            }

            // Hide login, show app
            document.getElementById("login").style.display = "none";
            document.getElementById("app").style.display = "block";

            connectWebSocket();
        };

        function updateStatusBar(code, userCount) {
            document.getElementById("sessionInfo").innerHTML = `Connected to session <span id="copyArea" style="cursor: pointer;"><strong>${code}</strong> <span id="copyIcon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></span></span>`;

            document.getElementById("userCount").innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> ${userCount}`;

            document.getElementById("copyArea").addEventListener("click", () => {
                navigator.clipboard.writeText(code);
                document.getElementById("copyIcon").innerHTML = " ✓";
                setTimeout(() => {
                    document.getElementById("copyIcon").innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
                }, 1000);
            });
        }



        // Events
        document.getElementById('authLink').onclick = (e) => {
            e.preventDefault();
            document.getElementById('auth-overlay').classList.add('active');
        };

        document.getElementById('closeAuth').onclick = () => {
            document.getElementById('auth-overlay').classList.remove('active');
        };

        // Discord OAuth - handle mobile differently
        document.getElementById('authDiscord').onclick = () => {
            if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform()) {
                // Mobile: open in system browser with mobile flag
                window.open('/auth/discord?mobile=true', '_system');

                // Show code entry overlay
                document.getElementById('auth-overlay').classList.remove('active');
                document.getElementById('oauth-code-overlay').classList.add('active');
            } else {
                // Web/Desktop: normal redirect
                window.location.href = '/auth/discord';
            }
        };

        document.getElementById('signOutLink').onclick = async (e) => {
            e.preventDefault();
            await fetch('/auth/logout', { method: 'POST' });
            checkAuth();
        };

        async function checkAuth() {
            const res = await fetch('/auth/me');
            const user = await res.json();

            if (user) {
                document.getElementById('user-info').innerHTML = `${user.username} <span style="opacity: 0.6;">(${user.provider})</span> `;
                document.getElementById('authLink').style.display = 'none';
                document.getElementById('signOutLink').style.display = 'inline';

                // Load settings from server
                const settingsRes = await fetch('/app/settings');
                const settings = await settingsRes.json();

                if (settings) {
                    document.getElementById('workDuration').value = settings.workDuration;
                    document.getElementById('breakDuration').value = settings.breakDuration;
                    document.getElementById('soundEnabled').checked = settings.soundEnabled;
                    document.getElementById('notificationsEnabled').checked = settings.notificationsEnabled;

                    localStorage.setItem('workDuration', settings.workDuration);
                    localStorage.setItem('breakDuration', settings.breakDuration);
                    localStorage.setItem('soundEnabled', settings.soundEnabled);
                    localStorage.setItem('notificationsEnabled', settings.notificationsEnabled);
                }

                // If already in a session, save it to this account
                if (sessionCode) {
                    fetch('/app/session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionCode: sessionCode })
                    });
                }

                // Check for saved session
                const sessionRes = await fetch('/app/session');
                const savedSession = await sessionRes.json();
                if (savedSession) {
                    document.getElementById('resumeBtn').style.display = 'inline-block';
                    document.getElementById('resumeBtn').textContent = `Resume (${savedSession})`;
                    document.getElementById('resumeBtn').onclick = () => {
                        sessionCode = savedSession;
                        document.getElementById('login').style.display = 'none';
                        document.getElementById('app').style.display = 'block';
                        connectWebSocket();
                    };
                }
            } else {
                document.getElementById('user-info').textContent = '';
                document.getElementById('authLink').style.display = 'inline';
                document.getElementById('signOutLink').style.display = 'none';
            }
        }

        checkAuth();

        document.getElementById('start').onclick = () => {
            if (typeof Notification !== 'undefined') {
                Notification.requestPermission();
            }
            ws.send(JSON.stringify({type: 'start'}));
            sounds.start.play();
        };

        document.getElementById('stop').onclick = () => {
            ws.send(JSON.stringify({type: 'stop'}));
            sounds.stop.play();
        };

        document.getElementById('reset').onclick = () => {
            ws.send(JSON.stringify({type: 'reset'}));
            sounds.reset.play();
        };

        document.getElementById('timerMode').onclick = () => {
            mode = mode === "work" ? "break" : "work";
            ws.send(JSON.stringify({type: "toggleMode"}));
        };

        // Open OTP overlay from auth panel
        document.getElementById('authOtp').onclick = (e) => {
            e.preventDefault();
            document.getElementById('auth-overlay').classList.remove('active');
            document.getElementById('otp-overlay').classList.add('active');
        };

        document.getElementById('oauthCodeVerifyBtn').onclick = async () => {
            const code = document.getElementById('oauthCode').value;

            if (!code) {
                alert('Please enter code');
                return;
            }

            const res = await fetch('/auth/otp/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });

            const data = await res.json();
            if (data.success) {
                document.getElementById('oauth-code-overlay').classList.remove('active');
                document.getElementById('oauthCode').value = '';
                checkAuth();
            } else {
                alert(data.error || 'Invalid code');
            }
        };

        document.getElementById('closeOauthCode').onclick = () => {
            document.getElementById('oauth-code-overlay').classList.remove('active');
        };

        // Register flow
        let registerEmail = '';
        let registerUsername = '';

        document.getElementById('registerBtn').onclick = async () => {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;

            if (!username || !email) {
                alert('Please enter username and email');
                return;
            }

            const res = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, username, requireOtp: true })
            });

            const data = await res.json();
            if (data.success) {
                registerEmail = email;
                registerUsername = username;

                // Close register, open OTP verify
                document.getElementById('register-overlay').classList.remove('active');
                document.getElementById('otp-overlay').classList.add('active');
                document.getElementById('otp-title').textContent = 'Verify Your Email';
                document.getElementById('otp-email-step').style.display = 'none';
                document.getElementById('otp-code-step').style.display = 'block';
                document.getElementById('otpEmailDisplay').value = email;
                otpEmail = email;
            } else {
                alert(data.error || 'Something went wrong');
            }
        };

        // Back to sign in from register
        document.getElementById('registerLoginLink').onclick = (e) => {
            e.preventDefault();
            document.getElementById('register-overlay').classList.remove('active');
            document.getElementById('auth-overlay').classList.add('active');
        };

        document.getElementById('closeRegister').onclick = () => {
            document.getElementById('register-overlay').classList.remove('active');
        };

        // Update TOTP status when opening settings
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settings-overlay').classList.add('active');
            updateDangerZone();
            updateTotpStatus();
        });

        document.getElementById('menuSettingsBtn').addEventListener('click', () => {
            document.getElementById('settings-overlay').classList.add('active');
            updateDangerZone();
            updateTotpStatus();
        });

        // Show danger zone only if logged in
        function updateDangerZone() {
            fetch('/auth/me').then(r => r.json()).then(user => {
                document.getElementById('dangerZone').style.display = user ? 'flex' : 'none';
                document.getElementById('dangerZone').style.flexDirection = 'column';
                document.getElementById('dangerZone').style.gap = '0.5rem';
            });
        }

        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settings-overlay').classList.add('active');
            updateDangerZone();
        });

        document.getElementById("closeSettings").addEventListener("click", () => {
            document.getElementById("settings-overlay").classList.remove("active");
        });

        document.getElementById("saveSettings").addEventListener("click", () => {
            const workDuration = parseFloat(document.getElementById("workDuration").value);
            const breakDuration = parseFloat(document.getElementById("breakDuration").value);
            const soundEnabled = document.getElementById("soundEnabled").checked;
            const notificationsEnabled = document.getElementById("notificationsEnabled").checked;

            // Save to localStorage
            localStorage.setItem("workDuration", workDuration);
            localStorage.setItem("breakDuration", breakDuration);
            localStorage.setItem("soundEnabled", soundEnabled);
            localStorage.setItem("notificationsEnabled", notificationsEnabled);

            // Send to server if logged in
            fetch('/app/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ workDuration, breakDuration, soundEnabled, notificationsEnabled })
            });

            // Send to server only if connected
            if (ws && ws.readyState == WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "settings",
                    workDuration: workDuration,
                    breakDuration: breakDuration
                }));
            }

            // Close overlay
            document.getElementById("settings-overlay").classList.remove("active");
        });

        document.getElementById('menuSettingsBtn').addEventListener('click', () => {
            document.getElementById('settings-overlay').classList.add('active');
            updateDangerZone();
        });

        document.getElementById('deleteDataBtn').onclick = async () => {
            if (!confirm('Delete all your Bananadoro data? This cannot be undone.')) return;

            await fetch('/app/data', { method: 'DELETE' });

            // Reset client settings to defaults
            localStorage.setItem('workDuration', 25);
            localStorage.setItem('breakDuration', 5);
            localStorage.setItem('soundEnabled', true);
            localStorage.setItem('notificationsEnabled', true);

            document.getElementById('workDuration').value = 25;
            document.getElementById('breakDuration').value = 5;
            document.getElementById('soundEnabled').checked = true;
            document.getElementById('notificationsEnabled').checked = true;

            alert('Data deleted and reset to defaults.');
        };

        document.getElementById('deleteAccountBtn').onclick = async () => {
            if (!confirm('Delete your entire account? This cannot be undone.')) return;
            if (!confirm('Are you really sure? All data will be lost forever.')) return;

            await fetch('/app/data', { method: 'DELETE' });

            await fetch('/auth/account', { method: 'DELETE' });
            alert('Account deleted.');
            window.location.reload();
        };

        // Check for auth callback
        const params = new URLSearchParams(window.location.search);
        const authType = params.get('auth');

        if (authType === 'success') {
            history.replaceState({}, '', '/');
            checkAuth();
        }

        document.getElementById('homeBtn').onclick = () => {
            // Close websocket
            if (ws) ws.close();
            sessionCode = null;

            // Show login, hide app
            document.getElementById('login').style.display = 'flex';
            document.getElementById('app').style.display = 'none';

            // Reset title
            document.title = 'Bananadoro Timer';
        };

        // ============ OTP Login ============

        let otpEmail = '';

        document.getElementById('otpRequestBtn').onclick = async () => {
            const email = document.getElementById('otpEmail').value;
            if (!email) {
                alert('Please enter your email');
                return;
            }

            console.log('Requesting OTP for:', email);

            const res = await fetch('/auth/otp/request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });

            console.log('Response status:', res.status);
            const data = await res.json();
            console.log('Response data:', data);

            if (data.success) {
                otpEmail = email;
                document.getElementById('otpEmailDisplay').value = email;
                document.getElementById('otp-email-step').style.display = 'none';
                document.getElementById('otp-code-step').style.display = 'block';
            } else {
                alert(data.error || 'Something went wrong');
            }
        };

        document.getElementById('otpVerifyBtn').onclick = async () => {
            const code = document.getElementById('otpCode').value;
            if (!code) {
                alert('Please enter the code');
                return;
            }

            const res = await fetch('/auth/otp/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });

            const data = await res.json();

            if (data.success) {
                document.getElementById('otp-overlay').classList.remove('active');
                resetOtpForm();
                checkAuth();
            } else {
                alert(data.error || 'Invalid code');
            }
        };

        document.getElementById('otpResend').onclick = async (e) => {
            e.preventDefault();
            const res = await fetch('/auth/otp/request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: otpEmail })
            });

            const data = await res.json();
            if (data.success) {
                alert('Code resent!');
            } else {
                alert(data.error || 'Something went wrong');
            }
        };

        document.getElementById('closeOtp').onclick = () => {
            document.getElementById('otp-overlay').classList.remove('active');
            resetOtpForm();
        };

        function resetOtpForm() {
            otpEmail = '';
            document.getElementById('otpEmail').value = '';
            document.getElementById('otpCode').value = '';
            document.getElementById('otp-email-step').style.display = 'block';
            document.getElementById('otp-code-step').style.display = 'none';
        }

        // ============ TOTP Setup ============

        document.getElementById('totpEnableBtn').onclick = async () => {
            const code = document.getElementById('totpSetupCode').value;
            if (!code || code.length !== 6) {
                alert('Please enter a 6-digit code');
                return;
            }

            const res = await fetch('/auth/totp/enable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });

            const data = await res.json();
            if (data.success) {
                document.getElementById('totp-setup-overlay').classList.remove('active');
                alert('Two-factor authentication enabled!');
                updateTotpStatus();
            } else {
                alert(data.error || 'Invalid code');
            }
        };

        document.getElementById('closeTotpSetup').onclick = () => {
            document.getElementById('totp-setup-overlay').classList.remove('active');
        };

        async function setupTotp() {
            const res = await fetch('/auth/totp/setup', {
                method: 'POST'
            });

            const data = await res.json();
            if (data.secret && data.qrUrl) {
                document.getElementById('totp-secret').textContent = data.secret;
                // Generate QR code using a simple API
                document.getElementById('totp-qr').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(data.qrUrl)}" alt="QR Code">`;
                document.getElementById('totp-setup-overlay').classList.add('active');
            } else {
                alert(data.error || 'Could not setup 2FA');
            }
        }

        // ============ TOTP Verify (during login) ============

        document.getElementById('totpVerifyLoginBtn').onclick = async () => {
            const code = document.getElementById('totpLoginCode').value;
            const userId = document.getElementById('totpUserId').value;

            if (!code || code.length !== 6) {
                alert('Please enter a 6-digit code');
                return;
            }

            const res = await fetch('/auth/totp/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, code })
            });

            const data = await res.json();
            if (data.success) {
                document.getElementById('totp-verify-overlay').classList.remove('active');
                checkAuth();
            } else {
                alert(data.error || 'Invalid code');
            }
        };

        document.getElementById('closeTotpVerify').onclick = () => {
            document.getElementById('totp-verify-overlay').classList.remove('active');
        };

        // ============ TOTP Status in Settings ============

        async function updateTotpStatus() {
            const res = await fetch('/auth/totp/status');
            const data = await res.json();

            const totpBtn = document.getElementById('totpSettingsBtn');
            if (totpBtn) {
                totpBtn.textContent = data.enabled ? 'Disable 2FA' : 'Enable 2FA';
                totpBtn.onclick = data.enabled ? disableTotp : setupTotp;
            }
        }

        async function disableTotp() {
            const code = prompt('Enter your authenticator code to disable 2FA:');
            if (!code) return;

            const res = await fetch('/auth/totp/disable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });

            const data = await res.json();
            if (data.success) {
                alert('Two-factor authentication disabled');
                updateTotpStatus();
            } else {
                alert(data.error || 'Invalid code');
            }
        }
    </script>
</body>
</html>